<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Onboarding & Multi-Channel Conversion Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: #1e293b;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header p {
            margin: 12px 0 0 0;
            color: #64748b;
            font-size: 16px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3b82f6;
        }
        .metric-card.courses {
            border-left-color: #8b5cf6;
        }
        .metric-card.app {
            border-left-color: #10b981;
        }
        .metric-card.future {
            border-left-color: #f59e0b;
        }
        .metric-card h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            font-weight: 600;
        }
        .metric-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #1d4ed8;
            font-family: 'SF Mono', Monaco, 'Consolas', monospace;
        }
        .metric-card.courses .value {
            color: #8b5cf6;
        }
        .metric-card.app .value {
            color: #10b981;
        }
        .metric-card.future .value {
            color: #f59e0b;
        }
        .metric-card .subvalue {
            font-size: 14px;
            color: #64748b;
            margin-top: 4px;
        }
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }
        .charts-container-full {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .chart-container-large {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            grid-column: 1 / -1;
            margin-bottom: 24px;
        }
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #374151;
            text-align: center;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        .chart-wrapper-large {
            position: relative;
            height: 400px;
        }
        .data-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }
        .table-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 20px 24px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .table-header:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
        }
        .collapse-toggle {
            font-size: 20px;
            transition: transform 0.3s ease;
        }
        .collapse-toggle.collapsed {
            transform: rotate(-90deg);
        }
        .table-container {
            overflow-x: auto;
            transition: max-height 0.3s ease;
        }
        .table-container.collapsed {
            max-height: 0;
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 16px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }
        th {
            background: #eff6ff;
            font-weight: 600;
            color: #1e40af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .number-col {
            text-align: right;
            font-family: 'SF Mono', Monaco, 'Consolas', monospace;
        }
        .month-col {
            font-weight: 600;
            color: #1e293b;
        }
        .percentage-col {
            font-weight: 600;
            color: #1d4ed8;
        }
        .courses-col {
            color: #8b5cf6;
        }
        .app-col {
            color: #10b981;
        }
        .future-col {
            color: #f59e0b;
        }
        tr:hover {
            background-color: #f0f9ff;
        }
        .insights-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .insights-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #374151;
        }
        .insights-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }
        .insight-item {
            background: #f0f9ff;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .section-divider {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            height: 4px;
            border-radius: 2px;
            margin: 32px 0;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .controls-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #374151;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .filter-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        .filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .charts-container-full {
                grid-template-columns: 1fr;
            }
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .container {
                padding: 12px;
            }
            .header {
                padding: 20px;
            }
            .header h1 {
                font-size: 24px;
            }
            .filter-buttons {
                justify-content: center;
            }
            .filter-btn {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>User Onboarding & Multi-Channel Conversion Dashboard</h1>
            <p>Website-to-App conversions with immediate vs future payment tracking (January 2024 - May 2025)</p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Total Users Onboarded</h3>
                <div class="value" id="totalOnboarded">0</div>
                <div class="subvalue">17 months</div>
            </div>
            <div class="metric-card courses">
                <h3>Website Payments</h3>
                <div class="value" id="totalCourses">0</div>
                <div class="subvalue" id="coursesRate">0% of onboarded</div>
            </div>
            <div class="metric-card app">
                <h3>App Immediate Payments</h3>
                <div class="value" id="totalImmediate">0</div>
                <div class="subvalue" id="immediateRate">0% same month</div>
            </div>
            <div class="metric-card future">
                <h3>App Future Payments</h3>
                <div class="value" id="totalFuture">0</div>
                <div class="subvalue" id="futureRate">0% later months</div>
            </div>
            <div class="metric-card">
                <h3>Total Conversions</h3>
                <div class="value" id="totalConversions">0</div>
                <div class="subvalue" id="overallRate">0% overall rate</div>
            </div>
            <div class="metric-card courses">
                <h3>Website Peak Month</h3>
                <div class="value" id="bestWebsite">Nov 2024</div>
                <div class="subvalue">5,850 payments</div>
            </div>
        </div>

        <div class="controls">
            <div class="controls-title">Interactive Analysis</div>
            
            <div class="control-group">
                <label class="control-label">Filter by Year:</label>
                <div class="filter-buttons" id="yearFilters">
                    <button class="filter-btn active" data-year="all">All Years</button>
                    <button class="filter-btn" data-year="2024">2024</button>
                    <button class="filter-btn" data-year="2025">2025</button>
                </div>
            </div>
            
            <div class="control-group">
                <label class="control-label">Payment Channel Focus:</label>
                <div class="filter-buttons" id="channelFocus">
                    <button class="filter-btn active" data-focus="all">All Channels</button>
                    <button class="filter-btn" data-focus="website">Website Only</button>
                    <button class="filter-btn" data-focus="app">App Only</button>
                </div>
            </div>
        </div>

        <div class="chart-container-large">
            <div class="chart-title">Multi-Channel Conversion Trends</div>
            <div class="chart-wrapper-large">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>

        <div class="charts-container-full">
            <div class="chart-container">
                <div class="chart-title">Payment Channel Distribution</div>
                <div class="chart-wrapper">
                    <canvas id="channelDistributionChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Conversion Rates by Channel</div>
                <div class="chart-wrapper">
                    <canvas id="conversionRatesChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Website vs App Performance</div>
                <div class="chart-wrapper">
                    <canvas id="websiteVsAppChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-container">
                <div class="chart-title">Website Payment Evolution</div>
                <div class="chart-wrapper">
                    <canvas id="websiteEvolutionChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">App Conversion Pattern</div>
                <div class="chart-wrapper">
                    <canvas id="appConversionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="data-table">
            <div class="table-header" onclick="toggleTable('mainDataTable')">
                <span>Multi-Channel Conversion Analysis</span>
                <span class="collapse-toggle" id="mainDataTableToggle">▼</span>
            </div>
            <div class="table-container" id="mainDataTable">
                <table>
                    <thead>
                        <tr>
                            <th class="month-col">Month</th>
                            <th class="number-col">Users Onboarded</th>
                            <th class="number-col">Website Payments</th>
                            <th class="number-col">App Immediate</th>
                            <th class="number-col">App Future</th>
                            <th class="number-col">Total Payments</th>
                            <th class="number-col">Overall Rate</th>
                        </tr>
                    </thead>
                    <tbody id="mainTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section-divider"></div>

        <div class="data-table">
            <div class="table-header" onclick="toggleTable('channelAnalysis')">
                <span>Detailed Channel Performance</span>
                <span class="collapse-toggle" id="channelAnalysisToggle">▼</span>
            </div>
            <div class="table-container" id="channelAnalysis">
                <table>
                    <thead>
                        <tr>
                            <th class="month-col">Month</th>
                            <th class="number-col">Website Rate</th>
                            <th class="number-col">App Immediate Rate</th>
                            <th class="number-col">App Future Rate</th>
                            <th class="number-col">Website Share</th>
                            <th class="number-col">App Share</th>
                        </tr>
                    </thead>
                    <tbody id="channelTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="insights-section">
            <div class="insights-title">Key Insights</div>
            <div class="insights-list">
                <div class="insight-item">
                    <strong>Website-to-App Journey Launch:</strong> Website payments (courses) started in October 2024, indicating a strategic shift to capture users on the website before app conversion.
                </div>
                <div class="insight-item">
                    <strong>November 2024 Website Boom:</strong> Peak website performance with 5,850 course payments (18.5% of onboarded users), showing successful web monetization strategy.
                </div>
                <div class="insight-item">
                    <strong>Channel Shift Impact:</strong> Post-website launch, app immediate conversions shifted pattern - November showed 1,522 app payments vs 5,850 website payments.
                </div>
                <div class="insight-item">
                    <strong>Multi-Channel Success:</strong> Total conversion rates improved significantly after website launch - November achieved 24.5% overall conversion (vs ~3% in early 2024).
                </div>
                <div class="insight-item">
                    <strong>2025 Channel Balance:</strong> Website payments declined but maintained presence, with app conversions stabilizing at lower but consistent levels.
                </div>
                <div class="insight-item">
                    <strong>Website Conversion Efficiency:</strong> Website channel shows immediate payment behavior, with course buyers likely representing high-intent users.
                </div>
                <div class="insight-item">
                    <strong>Future App Revenue Stability:</strong> Despite website competition, app future conversions maintained consistency, showing loyal user base value.
                </div>
                <div class="insight-item">
                    <strong>Strategic Opportunity:</strong> The website-first, app-later funnel appears highly effective - consider expanding website course offerings to boost overall conversions.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Updated data with courses payments
        const rawData = [
            {"month": "January, 2024", "users_onboarded": 16969, "courses_payments": 0, "payments_done_within_month": 272, "payments_done_afterwards": 308},
            {"month": "February, 2024", "users_onboarded": 16168, "courses_payments": 0, "payments_done_within_month": 163, "payments_done_afterwards": 290},
            {"month": "March, 2024", "users_onboarded": 25160, "courses_payments": 0, "payments_done_within_month": 485, "payments_done_afterwards": 779},
            {"month": "April, 2024", "users_onboarded": 16833, "courses_payments": 0, "payments_done_within_month": 188, "payments_done_afterwards": 478},
            {"month": "May, 2024", "users_onboarded": 23813, "courses_payments": 0, "payments_done_within_month": 310, "payments_done_afterwards": 496},
            {"month": "June, 2024", "users_onboarded": 20044, "courses_payments": 0, "payments_done_within_month": 343, "payments_done_afterwards": 401},
            {"month": "July, 2024", "users_onboarded": 28094, "courses_payments": 0, "payments_done_within_month": 641, "payments_done_afterwards": 571},
            {"month": "August, 2024", "users_onboarded": 15087, "courses_payments": 0, "payments_done_within_month": 796, "payments_done_afterwards": 377},
            {"month": "September, 2024", "users_onboarded": 14702, "courses_payments": 0, "payments_done_within_month": 1528, "payments_done_afterwards": 309},
            {"month": "October, 2024", "users_onboarded": 19303, "courses_payments": 382, "payments_done_within_month": 1978, "payments_done_afterwards": 386},
            {"month": "November, 2024", "users_onboarded": 31701, "courses_payments": 5850, "payments_done_within_month": 1522, "payments_done_afterwards": 396},
            {"month": "December, 2024", "users_onboarded": 20938, "courses_payments": 1891, "payments_done_within_month": 935, "payments_done_afterwards": 348},
            {"month": "January, 2025", "users_onboarded": 26173, "courses_payments": 2091, "payments_done_within_month": 1080, "payments_done_afterwards": 179},
            {"month": "February, 2025", "users_onboarded": 12619, "courses_payments": 398, "payments_done_within_month": 362, "payments_done_afterwards": 42},
            {"month": "March, 2025", "users_onboarded": 7544, "courses_payments": 10, "payments_done_within_month": 163, "payments_done_afterwards": 29},
            {"month": "April, 2025", "users_onboarded": 5125, "courses_payments": 18, "payments_done_within_month": 125, "payments_done_afterwards": 15},
            {"month": "May, 2025", "users_onboarded": 3241, "courses_payments": 15, "payments_done_within_month": 98, "payments_done_afterwards": 10}
        ];

        // State management
        let currentFilters = {
            year: 'all',
            channelFocus: 'all'
        };

        // Chart instances
        let trendsChart;
        let channelDistributionChart;
        let conversionRatesChart;
        let websiteVsAppChart;
        let websiteEvolutionChart;
        let appConversionChart;

        // Color schemes
        const colors = {
            primary: '#3b82f6',
            secondary: '#1d4ed8',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            purple: '#8b5cf6',
            gray: '#6b7280',
            courses: '#8b5cf6',
            immediate: '#10b981',
            future: '#f59e0b',
            onboarded: '#3b82f6'
        };

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function toggleTable(tableId) {
            const table = document.getElementById(tableId);
            const toggle = document.getElementById(tableId + 'Toggle');
            
            if (table.classList.contains('collapsed')) {
                table.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.textContent = '▼';
            } else {
                table.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.textContent = '▲';
            }
        }

        function getFilteredData() {
            let data = [...rawData];
            
            if (currentFilters.year !== 'all') {
                data = data.filter(item => item.month.includes(currentFilters.year));
            }
            
            return data;
        }

        function calculateMetrics() {
            const data = getFilteredData();
            
            const totalOnboarded = data.reduce((sum, item) => sum + item.users_onboarded, 0);
            const totalCourses = data.reduce((sum, item) => sum + item.courses_payments, 0);
            const totalImmediate = data.reduce((sum, item) => sum + item.payments_done_within_month, 0);
            const totalFuture = data.reduce((sum, item) => sum + item.payments_done_afterwards, 0);
            const totalConversions = totalCourses + totalImmediate + totalFuture;
            
            const coursesRate = ((totalCourses / totalOnboarded) * 100).toFixed(1);
            const immediateRate = ((totalImmediate / totalOnboarded) * 100).toFixed(1);
            const futureRate = ((totalFuture / totalOnboarded) * 100).toFixed(1);
            const overallRate = ((totalConversions / totalOnboarded) * 100).toFixed(1);
            
            document.getElementById('totalOnboarded').textContent = formatNumber(totalOnboarded);
            document.getElementById('totalCourses').textContent = formatNumber(totalCourses);
            document.getElementById('totalImmediate').textContent = formatNumber(totalImmediate);
            document.getElementById('totalFuture').textContent = formatNumber(totalFuture);
            document.getElementById('totalConversions').textContent = formatNumber(totalConversions);
            document.getElementById('coursesRate').textContent = coursesRate + '% of onboarded';
            document.getElementById('immediateRate').textContent = immediateRate + '% same month';
            document.getElementById('futureRate').textContent = futureRate + '% later months';
            document.getElementById('overallRate').textContent = overallRate + '% overall rate';
        }

        function initializeFilters() {
            // Year filter event listeners
            document.querySelectorAll('#yearFilters .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const year = btn.getAttribute('data-year');
                    updateYearFilter(year);
                });
            });
            
            // Channel focus filter event listeners
            document.querySelectorAll('#channelFocus .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const focus = btn.getAttribute('data-focus');
                    updateChannelFocusFilter(focus);
                });
            });
        }

        function updateYearFilter(year) {
            currentFilters.year = year;
            
            // Update button states
            document.querySelectorAll('#yearFilters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-year') === year);
            });
            
            updateDashboard();
        }

        function updateChannelFocusFilter(focus) {
            currentFilters.channelFocus = focus;
            
            // Update button states
            document.querySelectorAll('#channelFocus .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-focus') === focus);
            });
            
            updateCharts();
        }

        function updateDashboard() {
            calculateMetrics();
            updateCharts();
            populateTables();
        }

        function updateCharts() {
            try {
                if (trendsChart) updateTrendsChart();
                if (channelDistributionChart) updateChannelDistributionChart();
                if (conversionRatesChart) updateConversionRatesChart();
                if (websiteVsAppChart) updateWebsiteVsAppChart();
                if (websiteEvolutionChart) updateWebsiteEvolutionChart();
                if (appConversionChart) updateAppConversionChart();
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        function createTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Users Onboarded',
                        data: [],
                        borderColor: colors.onboarded,
                        backgroundColor: colors.onboarded + '20',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Website Payments',
                        data: [],
                        borderColor: colors.courses,
                        backgroundColor: colors.courses + '20',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }, {
                        label: 'App Immediate',
                        data: [],
                        borderColor: colors.immediate,
                        backgroundColor: colors.immediate + '20',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }, {
                        label: 'App Future',
                        data: [],
                        borderColor: colors.future,
                        backgroundColor: colors.future + '20',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Users Onboarded' },
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Payments' },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
            
            updateTrendsChart();
        }

        function updateTrendsChart() {
            if (!trendsChart) return;
            
            try {
                const data = getFilteredData();
                
                const labels = data.map(item => item.month.replace(', ', '\n'));
                const onboardedData = data.map(item => item.users_onboarded);
                const coursesData = data.map(item => item.courses_payments);
                const immediateData = data.map(item => item.payments_done_within_month);
                const futureData = data.map(item => item.payments_done_afterwards);
                
                trendsChart.data.labels = labels;
                trendsChart.data.datasets[0].data = onboardedData;
                trendsChart.data.datasets[1].data = coursesData;
                trendsChart.data.datasets[2].data = immediateData;
                trendsChart.data.datasets[3].data = futureData;
                
                // Apply channel focus filter
                if (currentFilters.channelFocus === 'website') {
                    trendsChart.data.datasets[1].hidden = false;
                    trendsChart.data.datasets[2].hidden = true;
                    trendsChart.data.datasets[3].hidden = true;
                } else if (currentFilters.channelFocus === 'app') {
                    trendsChart.data.datasets[1].hidden = true;
                    trendsChart.data.datasets[2].hidden = false;
                    trendsChart.data.datasets[3].hidden = false;
                } else {
                    trendsChart.data.datasets[1].hidden = false;
                    trendsChart.data.datasets[2].hidden = false;
                    trendsChart.data.datasets[3].hidden = false;
                }
                
                trendsChart.update('none');
            } catch (error) {
                console.error('Error updating trends chart:', error);
            }
        }

        function createChannelDistributionChart() {
            const ctx = document.getElementById('channelDistributionChart').getContext('2d');
            
            const data = getFilteredData();
            const totalCourses = data.reduce((sum, item) => sum + item.courses_payments, 0);
            const totalImmediate = data.reduce((sum, item) => sum + item.payments_done_within_month, 0);
            const totalFuture = data.reduce((sum, item) => sum + item.payments_done_afterwards, 0);
            
            channelDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Website Payments', 'App Immediate', 'App Future'],
                    datasets: [{
                        data: [totalCourses, totalImmediate, totalFuture],
                        backgroundColor: [colors.courses, colors.immediate, colors.future]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    const total = data.datasets[0].data.reduce((sum, value) => sum + value, 0);
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                        return {
                                            text: `${label} (${formatNumber(value)} - ${percentage}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            strokeStyle: data.datasets[0].backgroundColor[i],
                                            lineWidth: 0,
                                            index: i
                                        };
                                    });
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChannelDistributionChart() {
            const data = getFilteredData();
            const totalCourses = data.reduce((sum, item) => sum + item.courses_payments, 0);
            const totalImmediate = data.reduce((sum, item) => sum + item.payments_done_within_month, 0);
            const totalFuture = data.reduce((sum, item) => sum + item.payments_done_afterwards, 0);
            
            channelDistributionChart.data.datasets[0].data = [totalCourses, totalImmediate, totalFuture];
            channelDistributionChart.update();
        }

        function createConversionRatesChart() {
            const ctx = document.getElementById('conversionRatesChart').getContext('2d');
            
            conversionRatesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Website Rate %',
                        data: [],
                        borderColor: colors.courses,
                        backgroundColor: colors.courses + '20',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    }, {
                        label: 'App Immediate Rate %',
                        data: [],
                        borderColor: colors.immediate,
                        backgroundColor: colors.immediate + '20',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    }, {
                        label: 'App Future Rate %',
                        data: [],
                        borderColor: colors.future,
                        backgroundColor: colors.future + '20',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 25,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            updateConversionRatesChart();
        }

        function updateConversionRatesChart() {
            const data = getFilteredData();
            
            const labels = data.map(item => item.month.split(', ')[0]);
            const coursesRates = data.map(item => ((item.courses_payments / item.users_onboarded) * 100).toFixed(1));
            const immediateRates = data.map(item => ((item.payments_done_within_month / item.users_onboarded) * 100).toFixed(1));
            const futureRates = data.map(item => ((item.payments_done_afterwards / item.users_onboarded) * 100).toFixed(1));
            
            conversionRatesChart.data.labels = labels;
            conversionRatesChart.data.datasets[0].data = coursesRates;
            conversionRatesChart.data.datasets[1].data = immediateRates;
            conversionRatesChart.data.datasets[2].data = futureRates;
            conversionRatesChart.update();
        }

        function createWebsiteVsAppChart() {
            const ctx = document.getElementById('websiteVsAppChart').getContext('2d');
            
            websiteVsAppChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Website',
                        data: [],
                        backgroundColor: colors.courses,
                        borderColor: colors.courses,
                        borderWidth: 1
                    }, {
                        label: 'App Total',
                        data: [],
                        backgroundColor: colors.immediate,
                        borderColor: colors.immediate,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
            
            updateWebsiteVsAppChart();
        }

        function updateWebsiteVsAppChart() {
            const data = getFilteredData();
            
            const labels = data.map(item => item.month.split(', ')[0]);
            const websiteData = data.map(item => item.courses_payments);
            const appData = data.map(item => item.payments_done_within_month + item.payments_done_afterwards);
            
            websiteVsAppChart.data.labels = labels;
            websiteVsAppChart.data.datasets[0].data = websiteData;
            websiteVsAppChart.data.datasets[1].data = appData;
            websiteVsAppChart.update();
        }

        function createWebsiteEvolutionChart() {
            const ctx = document.getElementById('websiteEvolutionChart').getContext('2d');
            
            websiteEvolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Website Payments',
                        data: [],
                        borderColor: colors.courses,
                        backgroundColor: colors.courses + '30',
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: colors.courses,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 3,
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
            
            updateWebsiteEvolutionChart();
        }

        function updateWebsiteEvolutionChart() {
            const data = getFilteredData();
            
            const labels = data.map(item => item.month.split(', ')[0]);
            const websiteData = data.map(item => item.courses_payments);
            
            websiteEvolutionChart.data.labels = labels;
            websiteEvolutionChart.data.datasets[0].data = websiteData;
            websiteEvolutionChart.update();
        }

        function createAppConversionChart() {
            const ctx = document.getElementById('appConversionChart').getContext('2d');
            
            appConversionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Immediate',
                        data: [],
                        backgroundColor: colors.immediate,
                        borderColor: colors.immediate,
                        borderWidth: 1
                    }, {
                        label: 'Future',
                        data: [],
                        backgroundColor: colors.future,
                        borderColor: colors.future,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { stacked: true },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
            
            updateAppConversionChart();
        }

        function updateAppConversionChart() {
            const data = getFilteredData();
            
            const labels = data.map(item => item.month.split(', ')[0]);
            const immediateData = data.map(item => item.payments_done_within_month);
            const futureData = data.map(item => item.payments_done_afterwards);
            
            appConversionChart.data.labels = labels;
            appConversionChart.data.datasets[0].data = immediateData;
            appConversionChart.data.datasets[1].data = futureData;
            appConversionChart.update();
        }

        function populateTables() {
            populateMainTable();
            populateChannelTable();
        }

        function populateMainTable() {
            const tableBody = document.getElementById('mainTableBody');
            tableBody.innerHTML = '';
            
            const data = getFilteredData();
            
            data.forEach(row => {
                const totalPayments = row.courses_payments + row.payments_done_within_month + row.payments_done_afterwards;
                const overallRate = ((totalPayments / row.users_onboarded) * 100).toFixed(1);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="month-col">${row.month}</td>
                    <td class="number-col">${formatNumber(row.users_onboarded)}</td>
                    <td class="number-col courses-col">${formatNumber(row.courses_payments)}</td>
                    <td class="number-col app-col">${formatNumber(row.payments_done_within_month)}</td>
                    <td class="number-col future-col">${formatNumber(row.payments_done_afterwards)}</td>
                    <td class="number-col">${formatNumber(totalPayments)}</td>
                    <td class="number-col percentage-col">${overallRate}%</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function populateChannelTable() {
            const tableBody = document.getElementById('channelTableBody');
            tableBody.innerHTML = '';
            
            const data = getFilteredData();
            
            data.forEach(row => {
                const websiteRate = ((row.courses_payments / row.users_onboarded) * 100).toFixed(1);
                const immediateRate = ((row.payments_done_within_month / row.users_onboarded) * 100).toFixed(1);
                const futureRate = ((row.payments_done_afterwards / row.users_onboarded) * 100).toFixed(1);
                
                const totalPayments = row.courses_payments + row.payments_done_within_month + row.payments_done_afterwards;
                const websiteShare = totalPayments > 0 ? ((row.courses_payments / totalPayments) * 100).toFixed(1) : '0.0';
                const appShare = totalPayments > 0 ? (((row.payments_done_within_month + row.payments_done_afterwards) / totalPayments) * 100).toFixed(1) : '0.0';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="month-col">${row.month}</td>
                    <td class="number-col courses-col">${websiteRate}%</td>
                    <td class="number-col app-col">${immediateRate}%</td>
                    <td class="number-col future-col">${futureRate}%</td>
                    <td class="number-col courses-col">${websiteShare}%</td>
                    <td class="number-col app-col">${appShare}%</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // Initialize dashboard with error handling
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeFilters();
                calculateMetrics();
                populateTables();
                
                setTimeout(() => {
                    try {
                        createTrendsChart();
                        createChannelDistributionChart();
                        createConversionRatesChart();
                        createWebsiteVsAppChart();
                        createWebsiteEvolutionChart();
                        createAppConversionChart();
                    } catch (error) {
                        console.error('Chart creation error:', error);
                    }
                }, 500);
            } catch (error) {
                console.error('Dashboard initialization error:', error);
            }
        });

        // Fallback initialization if DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            // Do nothing, event listener will handle it
        } else {
            try {
                initializeFilters();
                calculateMetrics();
                populateTables();
                
                setTimeout(() => {
                    try {
                        createTrendsChart();
                        createChannelDistributionChart();
                        createConversionRatesChart();
                        createWebsiteVsAppChart();
                        createWebsiteEvolutionChart();
                        createAppConversionChart();
                    } catch (error) {
                        console.error('Chart creation error:', error);
                    }
                }, 500);
            } catch (error) {
                console.error('Dashboard initialization error:', error);
            }
        }
    </script>
</body>
</html>